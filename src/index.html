<html>

<head>
    <title> Cyberhawk 2015</title>
</head>
<!-- body -->

<body>
</body>
<!-- script -->
<script src="js/three.js"></script>
<script src="js/three.css3drenderer.js"></script>
<!--script src="js/tweenjs.js"></script-->
<script src="js/jquery.js"></script>
<script src="js/tween-lib.js"></script>
<script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">
<link rel="import" href="bower_components/paper-material/paper-material.html">
<link rel="import" href="bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="bower_components/paper-toast/paper-toast.html">
<link rel="import" href="bower_components/paper-progress/paper-progress.html">
<link rel="import" href="bower_components/polymer/polymer.html">
<script>
function popup_toast(string) {
    toast = document.querySelector("#toast");
    Polymer.dom(toastElement).textContent = string;
    toast.show();
}

function send_request_to_server(request_name, data, callback) {
    var REQUEST_URL = "http://iecsemanipal.com/cyberhawk/api";
    var API_KEY = "fUJxtW62tresIB7m";
    data["API_KEY"] = API_KEY;
    data["REQUEST"] = request_name;
    data["SECURITY"] = "OFF";

    console.log("sending request (" + request_name + ")", data);
    //onsole.log("stringified: ", jQuery.param(data))

    var requestFn = function() {
        $.ajax({
                type: "GET",
                url: REQUEST_URL,
                data: data,
            }).done(function(response) {
                console.log("response for (" + request_name + "): ", response);
                response = JSON.parse(response);
                callback && callback(response);
            })
            .fail(function(respose) {
                console.log("response for (" + request_name + "): ", response);

                response = JSON.parse(response);
                callback && callback(response);
            });
    };
    setTimeout(requestFn, 1000);
}

var REQUESTS = {
    //calls callback with true for successful login, false for unsucessful login
    login: function(email, password, callback) {
        data = {}
        data["EMAIL"] = email;
        data["PASSWORD"] = password;
        send_request_to_server("playerLogin", data, callback)
    },

    register: function(data, callback) {
        send_request_to_server("register", data, callback);

    },

    logout: function(sessionID) {
        data = {}
        data["sessionID"] = sessionID;
        send_request_to_server("playerLogout", data, function(response) {
            console.log("logged out");
        });
    },

    answer: function(sessionID, answer, callback) {
        data = {}
        data["sessionID"] = sessionID;
        data["ANSWER"] = answer;
        send_request_to_server("checkAnswer", data, callback);
    },

    next_question: function(sessionID, callback) {
        data = {}
        data["sessionID"] = sessionID;
        send_request_to_server("getQuestion", data, callback);
    }

}

var GLOBALS = {
    camera: null,
    cssRenderer: null,
    cssScene: null,
    mousePos: null,

}
var STATE = {
    questionNumber: 1,
    top_card: null,
    showing_hints: true,
    sessionID: null,


    switch_card_anim: function(new_top) {
        var old_top = this.top_card;
        new_top.position.y = -1000;
        new_top.position.z = 0;

        var hide_tween = new TWEEN.Tween(old_top.position)
            .to({
                z: -100
            }, 500)
            .easing(TWEEN.Easing.Cubic.In);

        var show_question_tween = new TWEEN.Tween(new_top.position).to({
            y: 0
        }).easing(TWEEN.Easing.Cubic.Out);;

        hide_tween.start();
        show_question_tween.delay(100).start();
        this.top_card = new_top;
    },

    try_login: function() {
        this.login_card_elem.login_button.disabled = true;
        this.profile_card_elem.logout_button.disabled = false;
        this.login_card_elem.login_progress.indeterminate = true;
    },

    error_login: function(error_message) {
        this.login_card_elem.login_button.disabled = false;
        this.login_card_elem.login_progress.indeterminate = false;
        this.login_card_elem.login_progress.value = 0;

        popup_toast(error_message);
    },

    try_register: function() {
        this.register_card_elem.register_button.disabled = true;
        this.register_card_elem.register_progress.indeterminate = true;

    },

    error_register: function(error_message) {
        this.register_card_elem.register_button.disabled = false;
        this.register_card_elem.register_progress.indeterminate = false;
        popup_toast(error_message)
    },
    success_register: function() {
        popup_toast("registered successfully");
    },

    try_answer: function(submit_button, answer_progress) {
        submit_button.disabled = true;
        answer_progress.indeterminate = true;
    },

    error_answer: function(submit_button, answer_progress) {
        submit_button.disabled = false;
        answer_progress.indeterminate = false;

        popup_toast("Wrong answer. Please try again");
    },

    hide_card: function(card_obj, delay) {
        delay = delay == undefined ? 0 : delay;
        var hide_tween = new TWEEN.Tween(card_obj.position).to({
            y: -1000
        }).easing(TWEEN.Easing.Cubic.In);
        hide_tween.delay(delay).start();

    },

    show_card: function(card_obj, delay) {
        var show_tween = new TWEEN.Tween(card_obj.position).to({
            y: 0
        }).easing(TWEEN.Easing.Cubic.Out);;
        show_tween.delay(delay).start();
    },

    show_profile: function() {
        this.show_card(this.profile_card_obj, 200);
    },

    hide_profile: function() {
        this.hide_card(this.profile_card_obj, 200)
    },

    show_hints: function() {
        this.show_card(this.hints_card_obj, 300);
    },

    hide_hints: function() {
        this.hide_card(this.hints_card_obj, 300);
        this.hide_card(this.rules_card_obj, 300);
    },


    logout: function() {
        //logout_button.disabled = true;
        this.profile_card_elem.logout_button.disabled = true;
        this.login_card_elem.login_button.disabled = false;
    }

}


function create_css3d_obj(elem) {
    var cssObject = new THREE.CSS3DObject(elem);
    return cssObject;
}

function attach_ripple(elem) {
    var ripple = document.createElement("paper-ripple");
    elem.appendChild(ripple);
}

function create_input(label) {
    var input = document.createElement("paper-input");
    input.setAttribute("label", label);
    return input;
}

function create_button(label) {
    var button = document.createElement("paper-button");
    //button.innerHTML = "Login";
    Polymer.dom(button).textContent = label;
    //button.setAttribute("raised", "true");
    return button;
}


function create_header(type, label) {
    var header = document.createElement(type);
    header.innerHTML = label;
    return header;
}

function create_progress() {
    var spinner = document.createElement("paper-progress");
    return spinner;
}

function create_question_card(content) {
    var card_elem = document.createElement("paper-material");
    card_elem.setAttribute("class", "card");
    card_elem.setAttribute("elevation", "5");
    //attach_ripple(card_elem);
    var question_progress = create_progress();
    card_elem.appendChild(question_progress);


    var question_container = document.createElement("div");
    question_container.setAttribute("class", "question-container");
    card_elem.appendChild(question_container);

    var question_title = create_header("h3", "Question " + STATE.questionNumber);
    question_container.appendChild(question_title);

    var content_region = document.createElement("div");
    content_region.setAttribute("class", "content-container");
    content_region.innerHTML = content;
    question_container.appendChild(content_region);

    var submit_form = document.createElement("form");
    submit_form.action = "#";
    question_container.appendChild(submit_form);

    var answer_input = create_input("Answer");
    submit_form.appendChild(answer_input);

    var submit_button = create_button("Submit")
    submit_form.appendChild(submit_button);


    submit_form.onsubmit = submit_button.onclick = function(e) {
        e.preventDefault();

        STATE.try_answer(submit_button, question_progress);
        //send answer request
        REQUESTS.answer(STATE.sessionID, answer_input.value, function(response) {
            var correct = response["data"] === true;

            if (correct) {
                REQUESTS.next_question(STATE.sessionID, function(response) {
                    var question = response["data"]["questionText"];
                    var question_card = create_question_card(question);
                    STATE.switch_card_anim(question_card);
                });
            } else {
                STATE.error_answer(submit_button, question_progress);
            }
        });
    }

    var hidden_submit = document.createElement("input");
    hidden_submit.type = "submit";
    hidden_submit.hidden = true;
    submit_form.appendChild(hidden_submit);

    var card_obj = create_css3d_obj(card_elem);
    GLOBALS.cssScene.add(card_obj);

    //store it in STATE
    STATE.questioncard_obj = card_obj;
    STATE.questioncard_elem = card_elem;

    return card_obj;

}

function create_login_card(cssScene) {
    var card_elem = document.createElement("paper-material");
    card_elem.setAttribute("class", "card");

    var login_progress = create_progress();
    card_elem.appendChild(login_progress);
    card_elem.login_progress = login_progress;


    var login_form = document.createElement("form");
    login_form.action = "#";
    login_form.setAttribute("class", "login-container");
    card_elem.appendChild(login_form)

    var header = create_header("h1", "Cyberhawk");
    login_form.appendChild(header);

    var email_input = create_input("E-mail id");
    login_form.appendChild(email_input);

    var password_input = create_input("password");
    password_input.setAttribute("type", "password")
    login_form.appendChild(password_input);


    var hidden_submit = document.createElement("input");
    hidden_submit.type = "submit";
    hidden_submit.hidden = true;
    login_form.appendChild(hidden_submit);

    var login_button = create_button("Login");
    login_form.appendChild(login_button);
    card_elem.login_button = login_button;

    var goto_register_button = create_button("Register now");
    login_form.appendChild(goto_register_button);


    goto_register_button.onclick = function() {
        STATE.switch_card_anim(STATE.register_card_obj);
    };
    //login onclick
    login_form.onsubmit = login_button.onclick = function(e) {
        e.preventDefault();
        STATE.try_login();

        if (email_input.value === "") {
            STATE.error_login("enter E-mail id");
            return;
        };
        if (password_input.value === "") {
            STATE.error_login("enter password");
        };
        REQUESTS.login(email_input.value, password_input.value, function(response) {

            if (response["data"] === "PARAMS-INVALID" ||
                response["data"] === "LOGIN-INVALID" ||
                response["responseType"] === "apiError") {
                STATE.error_login("wrong username or password");

            } else {
                console.log("response from login: ", response);
                STATE.sessionID = response["data"]["sessionID"];
                console.log("sessionID: ", STATE.sessionID);

                REQUESTS.next_question(STATE.sessionID, function(response) {
                    console.log("next question: ", response);
                    question = response["data"]["questionText"];
                    var question_card = create_question_card(question);
                    console.log(question_card);
                    STATE.switch_card_anim(question_card);
                    STATE.show_profile();
                    STATE.show_hints();
                });

            }
        });
    }

    var card_obj = create_css3d_obj(card_elem);
    GLOBALS.cssScene.add(card_obj);

    //store it in STATE
    STATE.login_card_obj = card_obj;
    STATE.login_card_elem = card_elem;

    card_obj.position.y = -1000;


    return card_obj;
}

function create_profile_card() {
    var card_elem = document.createElement("paper-material");
    card_elem.setAttribute("class", "card");
    card_elem.setAttribute("style", "width: 22%; height: 80%;");
    attach_ripple(card_elem);

    var profile_container = document.createElement("div");
    profile_container.setAttribute("class", "profile-container");
    card_elem.appendChild(profile_container);


    var profileName = create_header("h3", "Dummy Name");
    profileName.setAttribute("class", "profile-name");
    profile_container.appendChild(profileName);

    var leadersContainer = document.createElement("div");
    profile_container.appendChild(leadersContainer);

    var leadersHeading = create_header("h5", "Leaders");
    leadersContainer.appendChild(leadersHeading)


    var logout_button = create_button("Logout");
    profile_container.appendChild(logout_button);
    card_elem.logout_button = logout_button;

    logout_button.onclick = function() {
        REQUESTS.logout(STATE.sessionID);
        STATE.logout();
        STATE.switch_card_anim(STATE.login_card_obj);
        STATE.hide_profile();

        STATE.hide_card(STATE.hints_card_obj);
        STATE.hide_card(STATE.rules_card_obj);
    }

    var card_obj = create_css3d_obj(card_elem);
    GLOBALS.cssScene.add(card_obj);

    STATE.profile_card_obj = card_obj;
    STATE.profile_card_elem = card_elem;

    card_obj.position.y = -1000;

    return card_obj;
}

function create_hints_card() {
    var card_elem = document.createElement("paper-material");
    card_elem.setAttribute("class", "card");
    card_elem.setAttribute("style", "width: 25%; height: 80%");

    $(card_elem).click(function() {
        console.log("hints clicked");
        STATE.hide_card(STATE.hints_card_obj);
        STATE.show_card(STATE.rules_card_obj, 1000);
    });

    attach_ripple(card_elem);

    var hints_container = document.createElement("div");
    hints_container.setAttribute("class", "hints-container");
    card_elem.appendChild(hints_container);


    var hints_header = create_header("h3", "Hints");
    hints_container.appendChild(hints_header);

    var hints_container = document.createElement("div");
    hints_container.setAttribute("class", "hints-container");

    var card_obj = create_css3d_obj(card_elem);
    card_obj.position.y = -1000;

    GLOBALS.cssScene.add(card_obj);

    STATE.hints_card_obj = card_obj;
    STATE.hints_card_elem = card_elem;
}

function create_rules_card() {
    var card_elem = document.createElement("paper-material");
    card_elem.setAttribute("class", "card");
    card_elem.setAttribute("style", "width: 25%; height: 80%");

    $(card_elem).click(function() {
        console.log("rules clicked");
        STATE.hide_card(STATE.rules_card_obj);
        STATE.show_card(STATE.hints_card_obj, 1000);
    });
    attach_ripple(card_elem);

    var rules_container = document.createElement("div");
    rules_container.setAttribute("class", "rules-container");
    card_elem.appendChild(rules_container);

    var rules_header = create_header("h3", "Rules");
    rules_container.appendChild(rules_header);

    var card_obj = create_css3d_obj(card_elem);
    card_obj.position.z = -2;
    card_obj.position.y = -1000;

    GLOBALS.cssScene.add(card_obj);

    STATE.rules_card_obj = card_obj;
    STATE.rules_card_elem = card_elem;
}

function create_register_card() {
    var card_elem = document.createElement("paper-material");
    card_elem.setAttribute("class", "card");

    var register_progress = create_progress();
    card_elem.appendChild(register_progress);
    card_elem.register_progress = register_progress;


    var register_form = document.createElement("form");
    register_form.action = "#";
    register_form.setAttribute("class", "register-container");
    card_elem.appendChild(register_form)

    var header = create_header("h1", "Register");
    register_form.appendChild(header);


    var name_input = create_input("name");
    register_form.appendChild(name_input);



    var password_input = create_input("password");
    password_input.setAttribute("type", "password")
    register_form.appendChild(password_input);

    var password_resubmit_input = create_input("retype password");
    password_resubmit_input.setAttribute("type", "password")
    register_form.appendChild(password_resubmit_input);


    var email_input = create_input("E-mail");
    register_form.appendChild(email_input);


    var phone_input = create_input("Phone number");
    register_form.appendChild(phone_input);


    var college_input = create_input("College");
    register_form.appendChild(college_input);

    var hidden_submit = document.createElement("input");
    hidden_submit.type = "submit";
    hidden_submit.hidden = true;
    register_form.appendChild(hidden_submit);

    var register_button = create_button("Register");
    register_button.setAttribute("class", "spaced-button");
    register_form.appendChild(register_button);
    card_elem.register_button = register_button;


    var switch_to_login_button = create_button("Go to Login");
    register_form.appendChild(switch_to_login_button);

    switch_to_login_button.onclick = function() {
        STATE.switch_card_anim(STATE.login_card_obj);
    };

    //login onclick
    register_form.onsubmit = register_button.onclick = function(e) {
        e.preventDefault();

        STATE.try_register();

        data = {};
        data["NAME"] = name_input.value;
        data["EMAIL"] = email_input.value;
        data["PASSWORD"] = password_input.value;
        data["COLLEGE"] = college_input.value;
        data["PHONE"] = phone_input.value;

        if (data["NAME"] === "") {
            STATE.error_register("enter username");
            return;
        };

        if (data["PASSWORD"] === "") {
            STATE.error_register("enter password");
            return;
        };
        var resubmit_password = password_resubmit_input.value;
        if (resubmit_password === "") {
            STATE.error_register("enter retyped password");
            return;

        }
        var simple_email_regex = /\S+@\S+\.\S+/;
        if (!simple_email_regex.test(data["EMAIL"])) {
            STATE.error_register("enter valid E-mail id");
        };

        if (data["PASSWORD"] !== resubmit_password) {
            STATE.error_register("passwords do not match");
            return;
        }
        if (data["PHONE"] === "") {
            STATE.error_register("enter the phone number");
            return;
        }
        if (data["COLLEGE"] === "") {
            STATE.error_register("enter college");
            return;
        };



        REQUESTS.register(data, function(response) {
            if (response["data"] === "PARAMS-INVALID") {
                STATE.error_register("invalid register info");


            } else {
                console.log("registered");
                STATE.success_register();
                STATE.switch_card_anim(STATE.login_card_obj);
            }
        });
    }

    var card_obj = create_css3d_obj(card_elem);
    GLOBALS.cssScene.add(card_obj);

    //store it in STATE
    STATE.register_card_obj = card_obj;
    STATE.register_card_elem = card_elem;

    STATE.top_card = card_obj;

    return card_obj;
}

function init() {
    //SETUP SCENE
    var cssScene = new THREE.Scene();
    GLOBALS.cssScene = cssScene;

    var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    GLOBALS.camera = camera;

    camera.position.z = 500;
    var cssRenderer = new THREE.CSS3DRenderer();
    GLOBALS.cssRenderer = cssRenderer;

    cssRenderer.setSize(window.innerWidth, window.innerHeight);
    cssRenderer.domElement.style.position = 'absolute';
    cssRenderer.domElement.style.top = 0;
    cssRenderer.domElement.style.background = '#161928';

    document.body.appendChild(cssRenderer.domElement);

    //SETUP TOAST
    toastElement = document.createElement("paper-toast");
    toastElement.setAttribute("z-index", "9999");
    toastElement.setAttribute("id", "toast");
    toastElement.setAttribute("duration", "5000");

    document.body.appendChild(toastElement);


    create_register_card(cssScene);
    create_login_card(cssScene);
    create_profile_card(cssScene);
    create_hints_card(cssScene);
    create_rules_card(cssScene);

    function make_register_slide_up() {
        STATE.register_card_obj.position.y = -2000;
        var slide_up_tween = new TWEEN.Tween(STATE.register_card_obj.position).to({
            y: 0
        }).easing(TWEEN.Easing.Cubic.Out);
        slide_up_tween.start();
    };
    make_register_slide_up();
};


function create_spring(initial_val) {

    function setter_fn(value) {
        this.target = value;
    }

    function getter_fn(value) {
        return this.current;
    }

    function step_fn(t) {
        dt = (t - this.t) / 1000.0;
        this.t = t;

        const step_time = 1.0 / 60.0;

        if (dt > step_time * 10) {
            dt = step_time;
        }

        while (dt > 0) {
            const m = 50;
            var x = this.current - this.target;
            var a = (-1.0 * x - 1. * this.v) * m;

            this.v += a * dt;
            this.current += this.v * dt + 0.5 * a * dt * dt;

            dt -= step_time;
        };
    }
    var spring_system = {
        target: initial_val,
        current: 0,
        v: 0,
        a: 0,
        t: 0,
    };

    spring_system.set = setter_fn.bind(spring_system);
    spring_system.get = getter_fn.bind(spring_system);
    spring_system.step = step_fn.bind(spring_system);
    return spring_system;
}

function create_mouse_position_tracker() {
    GLOBALS.mousePos = {
        x: create_spring(0),
        y: create_spring(0),
    };

    $(document).mousemove(function(event) {
        GLOBALS.mousePos.x.set(event.pageX);
        GLOBALS.mousePos.y.set(event.pageY);
    });

}
var render = function(time) {
    requestAnimationFrame(render);
    const ROTATE_FACTOR = 0.4;


    GLOBALS.camera.rotation.y = -ROTATE_FACTOR * (GLOBALS.mousePos.x.get() - window.innerWidth * 0.5) / window.innerWidth;
    GLOBALS.camera.rotation.x = -ROTATE_FACTOR * (GLOBALS.mousePos.y.get() - window.innerHeight * 0.5) / window.innerHeight;

    //cssObject.rotation.x += 0.01;
    GLOBALS.cssRenderer.render(GLOBALS.cssScene, GLOBALS.camera);
    GLOBALS.mousePos.x.step(time);
    GLOBALS.mousePos.y.step(time);
    TWEEN.update(time);
};

//onresize handler
window.onresize = function() {

    GLOBALS.camera.aspectRatio = window.innerWidth / window.innerHeight;
    GLOBALS.cssRenderer.setSize(window.innerWidth, window.innerHeight);

    STATE.profile_card_obj.position.x = window.innerWidth * 0.35;
    STATE.hints_card_obj.position.x = -window.innerWidth * 0.35;
    STATE.rules_card_obj.position.x = -window.innerWidth * 0.35;
    console.log("resized!");
};

init();
create_mouse_position_tracker();
window.onresize();
render();
</script>
<!-- style -->
<style type="text/css">
body {
    margin: 0;
    font-family: "Meslo LG S DZ for Powerline" !important;
    font-weight: 200;
}

canvas {
    width: 100%;
    height: 100%;
}

.card {
    width: 40%;
    height: 90%;
    background-color: #24263D;
    color: #dfdfdf;
}

paper-progress {
    width: 100%;
}

#active-progress.paper-progress,
#indeterminateSplitter,
.indeterminate {
    background-color: #6A7DD3 !important;
}


/* login */

.register-container,
.login-container,
.question-container {
    padding-top: 20%;
    padding-left: 20%;
    padding-right: 20%;
}

.login-container paper-button {
    margin-top: 10%;
}

paper-button {
    background: #5ECBEE;
    color: #dfdfdf;
    padding-left: 10%;
    padding-right: 10%;
}

.paper-input,
label {
    color: #bfbfbf !important;
}

.focused-line {
    background: #bfbfbf !important;
}

paper-input-container input,
paper-input-container label {
    font-family: "Meslo LG S DZ for Powerline" !important;
    color: #dfdfdf;
    --paper-input-container-focus-color: #dfdfdf;
}


/*register, login*/

.spaced-button {
    margin-top: 1em;
    margin-bottom: 1em;
}


/* question */

.question-container h3 {}

.question-container .content-container {
    margin-top: 30%;
    margin-bottom: 30%;
}

.question-container paper-input {
    margin-bottom: 10%;
}

.question-container paper-button {
    margin-top: 20%;
}


/*profile*/

.profile-container {
    padding-top: 10%;
    padding-bottom: 30%;
    padding-left: 10%;
    padding-right: 10%;
}

.profile-container paper-button {
    margin-top: 20%;
}


/*
   hints
 */

.hints-container,
.rules-container {
    padding-top: 10%;
    padding-bottom: 30%;
    padding-left: 10%;
    padding-right: 10%;
}
</style>

</html>
